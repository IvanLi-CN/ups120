# 设备逻辑拆分到独立的 Embassy 任务计划

**目标：** 将 Bq25730、Ina226 和 Bq76920 这三个设备的逻辑拆分到独立的 Embassy 任务中，并分别存放在以硬件命名的文件中，以更好地管理设备状态和错误处理。

**计划步骤：**

1.  **分析现有实现：**
    *   仔细阅读 `src/main.rs` 中当前处理 Bq25730、Ina226 和 Bq76920 的代码段。
    *   理解设备初始化、数据读取、状态检查和错误处理是如何在当前的 `main` 异步函数中实现的。
    *   分析 `src/shared.rs` 中定义的 pub/sub 机制，确认其如何用于设备数据和警报的共享。

2.  **创建新的设备模块和文件：**
    *   在 `src/` 目录下创建新的文件：
        *   `src/bq25730_task.rs`
        *   `src/ina226_task.rs`
        *   `src/bq76920_task.rs`
    *   在这些文件中，分别定义对应设备的异步任务函数（例如 `bq25730_task`）。

3.  **重构设备逻辑：**
    *   将 `src/main.rs` 中与特定设备相关的初始化代码、I2C 通信（或其他总线通信）逻辑、数据解析、状态更新和错误处理代码，迁移到相应的设备任务文件中。
    *   每个任务文件将包含该设备的驱动实例、状态变量以及任务函数。
    *   在 `src/lib.rs` 或 `src/main.rs` 中声明这些新的模块。

4.  **更新 `main` 函数：**
    *   修改 `src/main.rs` 中的 `main` 异步函数。
    *   `main` 函数将保留系统级别的初始化（如时钟、外设配置）。
    *   从新创建的模块中导入设备任务函数。
    *   使用 embassy 的 `spawner` 来启动（spawn）导入的设备任务函数。
    *   `main` 函数在启动任务后可以进入一个空循环或执行其他高级协调逻辑（如果需要）。

5.  **维护任务间通信：**
    *   确保新的设备任务继续使用 `src/shared.rs` 中定义的 pub/sub 机制来发布测量数据和警报。
    *   可能需要在设备任务文件中引入 `src/shared.rs` 中的相关定义。
    *   其他需要这些数据的任务（例如，处理 USB 通信的任务）将继续通过订阅相应的 pub/sub 通道来获取数据。

6.  **增强错误处理：**
    *   在每个设备任务文件内部实现更精细的错误处理逻辑。
    *   当设备通信失败或检测到异常状态时，任务可以记录错误、尝试恢复操作，或者通过 pub/sub 机制发布错误事件，以便其他任务能够感知并作出响应。

7.  **测试：**
    *   编写或修改测试用例，验证每个设备任务能够独立正确地初始化和运行。
    *   测试任务之间通过 pub/sub 进行数据通信的正确性。
    *   模拟设备错误情况，验证错误处理逻辑是否按预期工作。

**计划流程图：**

```mermaid
graph TD
    A[系统初始化] --> B(启动 bq25730_task)
    A --> C(启动 ina2226_task)
    A --> D(启动 bq76920_task)
    B --> B1{bq25730_task.rs 逻辑}
    C --> C1{ina226_task.rs 逻辑}
    D --> D1{bq76920_task.rs 逻辑}
    B1 --> E[发布 Bq25730 数据/警报]
    C1 --> F[发布 Ina226 数据]
    D1 --> G[发布 Bq76920 数据/警报]
    E --> H(Pub/Sub)
    F --> H
    G --> H
    H --> I[其他任务 (例如 USB)]
